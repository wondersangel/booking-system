<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約系統原型</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .slot-card { cursor: pointer; transition: 0.3s; border: 1px solid #ddd; }
        .slot-card:hover { background-color: #f8f9fa; }
        .slot-card.selected { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .slot-card.full { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; pointer-events: none; }
        .slot-card.warning { border-color: #ffc107; background-color: #fff3cd; }
        .status-badge { float: right; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="container py-5">
    <h2 class="mb-4 text-center">預約系統 (Excel 數據驅動版)</h2>

    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">1. 系統初始化 (管理員/系統讀取)</div>
        <div class="card-body">
            <p class="small text-muted">請上傳含有現有預約資料的 Excel (.xlsx) 檔案。格式需包含欄位：<code>Date</code> (YYYY-MM-DD) 和 <code>Time</code> (HH:00)。</p>
            <input type="file" id="uploadExcel" class="form-control" accept=".xlsx, .xls" />
            <div id="dataStatus" class="mt-2 text-success" style="display:none;">✅ 數據已載入，共 <span id="recordCount">0</span> 條預約記錄</div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">2. 選擇預約日期</div>
        <div class="card-body">
            <input type="date" id="bookingDate" class="form-control" />
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">3. 選擇時段 (每節 1 小時)</div>
        <div class="card-body">
            <div id="slotsContainer" class="row g-3">
                <div class="col-12 text-center text-muted">請先上傳數據並選擇日期</div>
            </div>
        </div>
    </div>

    <div class="alert alert-info" id="selectionResult" style="display:none;">
        <strong>已選擇：</strong> <span id="resDate"></span> <span id="resTime"></span>
        <button class="btn btn-primary btn-sm float-end" onclick="alert('預約請求已發送 (需連接後端資料庫以儲存)')">確認預約</button>
    </div>
</div>

<script>
    let existingBookings = []; // 儲存 Excel 讀取出的數據
    const MAX_CAPACITY = 3;

    // 定義辦公時間時段
    const timeSlots = [
        "09:00", "10:00", "11:00", "12:00", // 上午 9-1
        // 13:00-14:00 午休
        "14:00", "15:00", "16:00"           // 下午 2-5 (16:00-17:00 是最後一節)
    ];

    // 1. 讀取 Excel 檔案
    document.getElementById('uploadExcel').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // 將 Excel 轉為 JSON 對象
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            // 簡單的資料清洗與儲存
            existingBookings = jsonData.map(row => ({
                // 假設 Excel 欄位名稱是 Date 和 Time
                // 處理 Excel 日期格式可能為數字的問題
                date: parseExcelDate(row['Date']), 
                time: row['Time']
            }));

            document.getElementById('dataStatus').style.display = 'block';
            document.getElementById('recordCount').innerText = existingBookings.length;
            refreshSlots(); // 如果日期已選，刷新時段
        };
        reader.readAsArrayBuffer(file);
    });

    // 日期改變時觸發
    document.getElementById('bookingDate').addEventListener('change', refreshSlots);

    function refreshSlots() {
        const selectedDate = document.getElementById('bookingDate').value;
        const container = document.getElementById('slotsContainer');
        container.innerHTML = ''; // 清空

        if (!selectedDate) return;

        timeSlots.forEach(time => {
            // 計算該日該時段的現有預約數
            const count = existingBookings.filter(b => b.date === selectedDate && b.time === time).length;
            const isFull = count >= MAX_CAPACITY;
            const isNearFull = count === (MAX_CAPACITY - 1);
            
            let statusClass = '';
            let statusText = `剩餘 ${MAX_CAPACITY - count} 組`;
            
            if (isFull) {
                statusClass = 'full';
                statusText = '已額滿';
            } else if (isNearFull) {
                statusClass = 'warning';
                statusText = '即將額滿';
            }

            // 構建 HTML
            const col = document.createElement('div');
            col.className = 'col-md-4 col-sm-6';
            col.innerHTML = `
                <div class="card slot-card p-3 ${statusClass}" onclick="selectSlot(this, '${time}')">
                    <div class="fw-bold">${time} - ${getNextHour(time)}</div>
                    <div class="status-badge badge ${isFull ? 'bg-secondary' : (isNearFull ? 'bg-warning text-dark' : 'bg-success')}">
                        ${statusText}
                    </div>
                </div>
            `;
            if(!isFull) container.appendChild(col); // 如果你想顯示已額滿的，就把if去掉
            else container.appendChild(col);
        });
    }

    let currentSelected = null;
    function selectSlot(element, time) {
        if (element.classList.contains('full')) return;

        // 移除其他選擇樣式
        document.querySelectorAll('.slot-card').forEach(el => el.classList.remove('selected'));
        
        // 加入當前選擇樣式
        element.classList.add('selected');
        
        // 顯示結果
        const date = document.getElementById('bookingDate').value;
        document.getElementById('selectionResult').style.display = 'block';
        document.getElementById('resDate').innerText = date;
        document.getElementById('resTime').innerText = time;
    }

    // 輔助工具：處理 Excel 日期序列號轉 YYYY-MM-DD
    function parseExcelDate(dateVal) {
        if (typeof dateVal === 'string') return dateVal; // 已經是字串
        // Excel 日期序列轉換
        const date = new Date((dateVal - (25567 + 2)) * 86400 * 1000);
        return date.toISOString().split('T')[0];
    }

    // 輔助工具：計算下一小時
    function getNextHour(timeStr) {
        let [h, m] = timeStr.split(':').map(Number);
        return `${String(h+1).padStart(2, '0')}:00`;
    }
</script>

</body>
</html>
